<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tab Visibility Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .visible {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .hidden {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Tab Visibility Debug Test</h1>
        <p>This page tests the tab visibility API that should be working in your Stoic app.</p>
        
        <div id="status" class="status visible">Tab is currently: VISIBLE</div>
        
        <h3>Instructions:</h3>
        <ol>
            <li>Keep this tab open</li>
            <li>Open a new tab and navigate to another website</li>
            <li>Wait a few seconds</li>
            <li>Return to this tab</li>
            <li>Check the logs below to see if events fired</li>
        </ol>
        
        <button onclick="clearLogs()">Clear Logs</button>
        <button onclick="testManualEvent()">Test Manual Event</button>
        <button onclick="checkCurrentState()">Check Current State</button>
        
        <h3>Event Log:</h3>
        <div id="log" class="log"></div>
        
        <h3>Current State:</h3>
        <div id="state" class="log"></div>
    </div>

    <script>
        let isTabVisible = true;
        let eventCount = 0;
        let lastEventTime = Date.now();
        
        function log(message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const entry = document.createElement('div');
            entry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            if (data) {
                entry.innerHTML += `<br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
            logElement.appendChild(entry);
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`, data || '');
        }
        
        function updateStatus(visible) {
            const statusElement = document.getElementById('status');
            if (visible) {
                statusElement.textContent = 'Tab is currently: VISIBLE';
                statusElement.className = 'status visible';
            } else {
                statusElement.textContent = 'Tab is currently: HIDDEN';
                statusElement.className = 'status hidden';
            }
        }
        
        function updateState() {
            const stateElement = document.getElementById('state');
            stateElement.innerHTML = `
                <strong>Document State:</strong><br>
                document.hidden: ${document.hidden}<br>
                document.visibilityState: ${document.visibilityState}<br>
                isTabVisible: ${isTabVisible}<br>
                eventCount: ${eventCount}<br>
                lastEventTime: ${new Date(lastEventTime).toLocaleTimeString()}
            `;
        }
        
        function handleVisibilityChange() {
            eventCount++;
            const wasVisible = isTabVisible;
            const isVisible = !document.hidden;
            const timeSinceLastEvent = Date.now() - lastEventTime;
            
            log('üîç Visibility change detected!', {
                wasVisible,
                isVisible,
                documentHidden: document.hidden,
                visibilityState: document.visibilityState,
                timeSinceLastEvent: Math.round(timeSinceLastEvent / 1000) + 's',
                eventNumber: eventCount
            });
            
            isTabVisible = isVisible;
            lastEventTime = Date.now();
            updateStatus(isVisible);
            updateState();
            
            if (isVisible && !wasVisible) {
                log('‚úÖ Tab became VISIBLE - this should trigger data refresh in your app!');
            } else if (!isVisible && wasVisible) {
                log('‚ùå Tab became HIDDEN');
            }
        }
        
        function clearLogs() {
            document.getElementById('log').innerHTML = '';
            eventCount = 0;
        }
        
        function testManualEvent() {
            log('üß™ Manual test event triggered');
            handleVisibilityChange();
        }
        
        function checkCurrentState() {
            log('üìä Current state check', {
                documentHidden: document.hidden,
                visibilityState: document.visibilityState,
                isTabVisible: isTabVisible,
                eventCount: eventCount
            });
            updateState();
        }
        
        // Set up the event listener
        document.addEventListener('visibilitychange', handleVisibilityChange);
        log('üöÄ Tab visibility test initialized');
        log('üìù Event listener added for "visibilitychange"');
        
        // Initial state
        updateState();
        
        // Test if the API is supported
        if (typeof document.hidden === 'undefined') {
            log('‚ùå ERROR: document.hidden is not supported in this browser!');
        } else {
            log('‚úÖ document.hidden API is supported');
        }
        
        if (typeof document.visibilityState === 'undefined') {
            log('‚ùå ERROR: document.visibilityState is not supported in this browser!');
        } else {
            log('‚úÖ document.visibilityState API is supported');
        }
    </script>
</body>
</html>
